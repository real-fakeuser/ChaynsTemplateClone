/* eslint-disable no-param-reassign,no-else-return */
import { shareProvider, shareActions } from './sharingProvider';

export function getAvailableShareProviders() {
    if (chayns.env.isApp) {
        return chayns.getAvailableSharingServices().then(function (response) {
            var sharingApps = response.availableSharingApps;
            shareProvider.forEach(function (curProvider) {
                if (curProvider.providerId < 0) {
                    return;
                }

                var shareApp = sharingApps.find(function (curApp) {
                    return curApp === curProvider.providerId;
                });

                if (shareApp !== undefined) {
                    curProvider.available = true;
                    curProvider.action = shareActions.shareWithApp;
                }
            });

            if (chayns.env.isAndroid) {
                shareProvider[0].available = true;

                var androidApps = response.availableAndroidApps;

                shareProvider.forEach(function (curProvider) {
                    if (!curProvider.androidIdentifier) {
                        return;
                    }

                    var shareApp = androidApps.find(function (curApp) {
                        return curApp === curProvider.androidIdentifier;
                    });

                    if (shareApp) {
                        curProvider.available = true;
                        curProvider.action = shareActions.shareWithApp;
                    }
                });
            }

            if (chayns.env.isIOS && chayns.env.appVersion >= 5182 || chayns.env.isAndroid && chayns.env.appVersion >= 5205) {
                shareProvider[shareProvider.length - 1].available = true;
            }

            return Promise.resolve(shareProvider);
        });
    } else {
        if (!chayns.env.isIOS) {
            shareProvider[0].available = true;
        }
        return Promise.resolve(shareProvider);
    }
}

export function getDefaultShareLink() {
    if (chayns.env.isChaynsWeb) {
        return chayns.env.site.url;
    }
    var tapp = chayns.env.site.tapps.find(function (element) {
        return element.id === chayns.env.site.tapp.id;
    });

    var shareLink = 'http://' + (chayns.env.site.domain || 'chayns.net/' + chayns.env.site.id) + '/';

    if (tapp) {
        shareLink += tapp.customUrl || 'tapp/index/' + tapp.id;
    } else {
        shareLink += 'tapp/index/' + chayns.env.site.tapp.id;
    }

    return shareLink;
}